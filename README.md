# rock-stadium

開発中のシステムで `SQLite` の読み書きがボトルネックになったため、爆速とされる `RocksDB` (Java版) への移行を検討した。
簡単な速度比較を行った結果は以下の通り。

※RocksDB は、使ってみると、いろいろクセがあったので、アクセスライブラリを作成した(RocksStadium)。

## SQLite Journalモード　（デフォルト）
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 255  | 31917 | 49   | 519    | 32462  | 0     | 65202 |
| 1     | 4    | 31301 | 21   | 462    | 31820  | 1     | 63609 |
| 2     | 8    | 41073 | 18   | 451    | 34185  | 1     | 75736 |
| av    | 89   | 34763 | 29   | 477    | 32822  | 0     | 68180 |

## SQLite Journalモード ＋ トランザクション
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 6    | 131   | 21   | 37     | 114    | 1     | 310   |
| 1     | 5    | 124   | 33   | 34     | 105    | 0     | 301   |
| 2     | 6    | 151   | 19   | 34     | 97     | 1     | 308   |
| av    | 5    | 135   | 24   | 35     | 105    | 0     | 304   |
※Write/Update/Delete を、それぞれ１トランザクションで実行

## SQLite WALモード
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 13   | 666   | 25   | 93     | 815    | 8     | 1620  |
| 1     | 8    | 691   | 20   | 91     | 842    | 7     | 1659  |
| 2     | 9    | 645   | 29   | 117    | 790    | 8     | 1598  |
| av    | 10   | 667   | 24   | 100    | 815    | 7     | 1623  |

## SQLite WALモード ＋ トランザクション
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 8    | 186   | 29   | 47     | 167    | 2     | 439   |
| 1     | 9    | 175   | 24   | 41     | 156    | 2     | 407   |
| 2     | 7    | 171   | 19   | 41     | 172    | 3     | 413   |
| av    | 8    | 177   | 24   | 43     | 165    | 2     | 419   |
※Write/Update/Delete を、それぞれ１トランザクションで実行

## RocksDB 生API
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 39   | 93    | 22   | 104    | 60     | 23    | 341   |
| 1     | 29   | 73    | 8    | 82     | 88     | 34    | 314   |
| 2     | 30   | 76    | 6    | 91     | 83     | 16    | 302   |
| av    | 32   | 80    | 12   | 92     | 77     | 24    | 317   |

## RocksDB RockStadiumを利用
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 45   | 85    | 24   | 103    | 75     | 19    | 351   |
| 1     | 33   | 81    | 16   | 88     | 69     | 23    | 310   |
| 2     | 32   | 89    | 19   | 106    | 65     | 38    | 349   |
| av    | 36   | 85    | 19   | 99     | 69     | 26    | 334   |

## RocksDB RockStadium + トランザクション
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 58   | 76    | 18   | 74     | 48     | 22    | 296   |
| 1     | 40   | 61    | 14   | 92     | 60     | 28    | 295   |
| 2     | 37   | 55    | 14   | 62     | 46     | 28    | 242   |
| av    | 45   | 64    | 15   | 76     | 51     | 26    | 277   |
※Write/Read/Update/Delete を、それぞれ１トランザクションで実行

## RocksDB RockStadium + Batch Write (atomicWrite)
| Trial | Open | Write | Read | Update | Delete | Close | Total |
|-------|------|-------|------|--------|--------|-------|-------|
| 0     | 36   | 31    | 12   | 33     | 14     | 29    | 155   |
| 1     | 33   | 32    | 13   | 32     | 12     | 30    | 152   |
| 2     | 41   | 37    | 19   | 41     | 11     | 24    | 173   |
| av    | 36   | 33    | 14   | 35     | 12     | 27    | 157   |
※Write/Update/Delete を、それぞれ１回の Batch Write で実行

## 結果の概要

- SQLite は、デフォルト設定(`Journal`モード)で使うと、書き込み系がめちゃくちゃ遅い。
- SQLite の書き込みはトランザクションで、という先人の教えは正しく、すべての書き込みを１トランザクションでやると RocksDB に比べても遜色がない。すべての処理を１トランザクションで行うのは、現実的ではないけど。。。
- SQLite も、`WAL`モード(& `Synchronous=NORMAL`) にすれば、かなり速くなる（Journalモードの40～50倍程度）。
- SQLite + WAL モードでは、トランザクションの効果が見られなくなった（やや遅くなったくらい）。トランザクションの回数が増えたら効果はあるのかも。
- RocksDB は、普通に使っても WALモードの SQLite の５倍程度速い。
- RocksDB で、`Transaction` や `BatchWrite` を使うとさらに 1.5～2倍速くなる。 
- アクセスライブラリ `RockStadium` を使うことによるオーバーヘッドは、無視できるレベルだった。

## 結論

- WALモードにすれば SQLite も十分速いので、通常なら、既存の実装を置き換える必要はなさそう。
- それでも、まだ、これがボトルネックになり、5～10倍程度の速度差に効果が期待できるケースにのみ、RocksDBへの移行を検討する価値がある。
- 新規実装の場合は、RocksDB の選択も視野に入れて設計するのもありかもしれない。

